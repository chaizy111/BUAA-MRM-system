# 系统设计报告

## 1 系统需求分析
- 病案管理系统的目标和预期功能

  病案管理系统的目标是根据现有的医院病案的管理模式以及病案使用需求，利用数据库对病案进行高效存储，查找，借阅，统计病案信息等操作，提高医院病案的管理效率，优化病案管理工作人员及病案使用者的工作与使用体验。

  病案管理系统的预期功能有基础的新建病案，修改病案，查询病案，删除病案。除了基础的CRUD操作之外，我们需要在病案管理系统中实现病案借阅归还功能，在实际应用场景中，科室中的医生需要借阅病人相关病案来详细了解病人的有关信息。另外，我们还需要实现数据统计相关功能，这对了解医院病人整体情况有很大的作用，可以为了解居民患病就医情况提供更好的帮助，同时方便医院根据这些统计数据对各部门做出更好的资源分配。

- 用户需求

  我们实现的病案管理系统中设计三类用户，病人、医生、病案管理人员（病案科的医生）。对于三类用户有着不同的需求，我们也因此需要给他们赋予不同的权限。

  对于病人，其无法对病案进行CUD操作，只能对病案进行查询，获得自己有关的病案信息。

  对于医生，其无法进行病案借阅的审批，以及医生不需要了解整体的统计数据，即无法使用数据统计功能。综上所述，医生可以进行全部CRUD操作，也可以提交病案借阅与归还申请，但其无法审批这些申请且不能查看病案统计数据。

  对于病案管理人员，我们应该赋予其最大最多的权限，所以我们允许他使用病案管理系统的全部功能。

- 数据流图

- 数据元素表

## 2 数据库系统的概念模式（E-R 图）
- 实体关系图（E-R 图）

- ```mermaid
  erDiagram
  	Login {
  		int uid
  		string name
  		string password
  		string identity
  	}
      Patient {
          string Name
          string Gender
          date BirthDate
          int Age
          string Nationality
          string PlaceOfBirth
          string Ethnicity
          string IDCardNumber PK
          string Occupation
          string MaritalStatus
          text CurrentAddress
          string Phone
          string PostalCode
          text HouseholdAddress
      }
      Contact {
          int ID PK
          string PatientID FK
          string Name
          string Relationship
          text Address
          string Phone
      }
      MedicalRecord {
          int MedicalRecordNumber PK
          string PatientIDCardNumber FK
          date AdmissionDate
          date DischargeDate
          int UnitID FK
          string AdmissionDiagnosisID FK
          string DischargeDiagnosisID FK
          string PathologicalDiagnosisID FK
          int TreatStaffID FK
          int BloodType FK
          string PayMentMethod
      }
      Disease {
          string DiseaseID PK
          string Description
      }
      Surgery {
          int SurgeryID PK
          int MedicalRecordID FK
          date SurgeryDate
          string SurgeryName
          int SurgeonID FK
          int AssistantSurgeonID FK
      }
      Unit {
          int UnitID PK
          string Name
      }
      Ward {
          int WardID PK
          int UnitID FK
          string Description
      }
      MedicalRecordWards {
          int MedicalRecordID FK
          int WardID FK
          datetime StartTime
          datetime EndTime
      }
      Cost {
          int CostID PK
          int MedicalRecordID FK
          float Amount
          string Kind
      }
      Staff {
          int StaffID PK
          string Name
          string Position
          int UnitID FK
      }
      BloodType {
          int BloodTypeID PK
          string Type
          string RhType
      }
      MedicalRecordBorrow {
          int BorrowID PK
          int MedicalRecordNumber FK
          datetime BorrowDate
          string BorrowedBy
          int UnitID FK
          int IDCardNumber
          text BorrowReason
          string ContactPhone
          string Approver
          string Status
      }
      MedicalRecordReturn {
          int ReturnID PK
          int MedicalRecordNumber FK
          datetime ReturnDate
          string ReturnedBy
          int UnitID FK
          int IDCardNumber
          string ContactPhone
      }
  
      Patient }|--|{ Contact : "has"
      Patient }|--|{ MedicalRecord : "has"
      MedicalRecord ||--o{ Surgery : "includes"
      MedicalRecord ||--o{ MedicalRecordWards : "admitted_in"
      MedicalRecord ||--o{ Cost : "has"
      MedicalRecord ||--o{ MedicalRecordBorrow : "borrowed"
      MedicalRecord ||--o{ MedicalRecordReturn : "returned"
      Surgery }|..|{ Staff : "performed_by" 
      Surgery }|..|{ Staff : "assisted_by"
      Unit  ||--o{  Staff : "has"
      Unit  ||--o{  Ward : "has"
      MedicalRecord ||--o{ Disease : "diagnoses"
      MedicalRecord ||--o{ BloodType : "has"
      MedicalRecordWards }|--|{ Ward : "has"
      Unit ||--o{ MedicalRecordBorrow : "related"
      Unit ||--o{ MedicalRecordReturn : "related"
      Staff ||--o{ MedicalRecordBorrow : "commit"
      Staff ||--o{ MedicalRecordReturn : "commit"
  ```

## 3 数据库系统的逻辑模式
- 分析关系模式的范式等级

- 将所有关系规范到第三范式（3NF）

  ### 第一范式（1NF）
  第一范式要求表中的每个字段都是不可分割的原子值。从您提供的表结构来看，所有字段都是基本数据类型，没有重复的组或数组，因此它们都满足1NF。

  ### 第二范式（2NF）
  第二范式要求满足1NF，并且所有非主键属性完全依赖于主键。这意味着没有非主键属性依赖于主键的一部分（部分依赖）。从您提供的表结构来看，大部分表都满足2NF，但是需要检查是否存在部分依赖的情况。

  ### 第三范式（3NF）
  第三范式要求满足2NF，并且所有非主键属性不传递依赖于主键。这意味着一个非主键属性不能依赖于另一个非主键属性。

  ### 分析和规范化建议

  1. **User 表**
     - 已经满足3NF，因为所有属性都直接依赖于主键`uid`。
  2. **Patient 表**
     - 满足3NF，所有的属性都直接依赖与主键IDCardNum。
  3. **Contact 表**
     - 可能存在部分依赖，因为`PatientID`是外键，但其他字段如`Name`, `Relationship`, `Address`, `Phone`可能都依赖于`PatientID`。如果`PatientID`是唯一的，那么这些字段应该直接依赖于`PatientID`。
  4. **MedicalRecord 表**
     - 存在传递依赖。`UnitID`, `TreatStaffID`, `BloodType` 等字段都依赖于`PatientIDCardNumber`，而不是直接依赖于主键`MedicalRecordNumber`。应该将这些字段直接关联到主键。
  5. **Disease 表**
     - 已经满足3NF，因为所有属性都直接依赖于主键`DiseaseID`。
  6. **Surgery 表**
     - 满足3NF，`SurgeryDate`, `SurgeryName` 等字段直接依赖于主键`SurgeryID`。
  7. **Unit, Ward, Cost, Staff, BloodType 表**
     - 满足3NF，因为所有属性都直接依赖于各自的主键。
  8. **MedicalRecordBorrow 和 MedicalRecordReturn 表**
     - 满足3NF，不存在传递依赖。`BorrowDate`, `BorrowedBy`, `BorrowReason`, `ContactPhone`, `Approver`, `Status` 和 `ReturnDate`, `ReturnedBy`, `ContactPhone` 等字段都依赖于BorrowID和ReturnID，这两个是各自表的主键。


#  系统实现总结报告

#### 2.1 实现环境
前端实现环境：

后端实现环境：PyCharm 2023.3.2 (Community Edition),  Visual Studio Code Ver 1.95.2（user setup），MySQL  Ver 8.0.39 for Win64 on x86_64 (MySQL Community Server - GPL)， python3.12

#### 2.2 系统功能结构图
主页功能菜单栏

#### 2.3 基本表的定义
1. **User**
   - uid（用户ID）：INT NOT NULL AUTO_INCREMENT, 主键
   - name（姓名）：VARCHAR(45) NOT NULL
   - password（密码）：VARCHAR(45) NOT NULL
   - identity（身份）：ENUM('Patient', 'Doctor', 'Manager') NOT NULL DEFAULT 'Patient'
2. **Patient**
   - Name（姓名）：VARCHAR(255) NOT NULL
   - Gender（性别）：ENUM('1', '2') NOT NULL
   - BirthDate（出生日期）：DATE NOT NULL
   - Age（年龄）：INT
   - Nationality（国籍）：VARCHAR(50）
   - PlaceOfBirth（出生地）：VARCHAR(255)
   - Ethnicity（种族）：VARCHAR(50)
   - IDCardNumber（身份证号码）：VARCHAR(18) UNIQUE NOT NULL, 主键
   - Occupation（职业）：VARCHAR(100)
   - MaritalStatus（婚姻状况）：ENUM('Married', 'Single', 'Divorced', 'Widowed')
   - CurrentAddress（当前地址）：TEXT
   - Phone（电话）：VARCHAR(20)
   - PostalCode（邮政编码）：VARCHAR(10)
   - HouseholdAddress（户籍地址）：TEXT
3. **Contact**
   - ID（ID）：INT AUTO_INCREMENT, 主键
   - PatientID（患者身份证号码）：VARCHAR(18), 外键
   - Name（姓名）：VARCHAR(255) NOT NULL
   - Relationship（关系）：VARCHAR(50)
   - Address（地址）：TEXT
   - Phone（电话）：VARCHAR(20)
4. **MedicalRecord**
   - MedicalRecordNumber（病历编号）：INT AUTO_INCREMENT, 主键
   - PatientIDCardNumber（患者身份证号码）：VARCHAR(18), 外键
   - AdmissionDate（入院日期）：DATE
   - DischargeDate（出院日期）：DATE
   - UnitID（科室ID）：INT, 外键
   - AdmissionDiagnosisID（入院诊断ID）：VARCHAR(255), 外键
   - DischargeDiagnosisID（出院诊断ID）：VARCHAR(255), 外键
   - PathologicalDiagnosisID（病理诊断ID）：VARCHAR(255), 外键
   - TreatStaffID（治疗人员ID）：INT, 外键
   - BloodType（血型ID）：INT, 外键
   - PayMentMethod（支付方式）：VARCHAR(50)
5. **Disease**
   - DiseaseID（疾病ID）：VARCHAR(255) NOT NULL, 主键
   - Description（描述）：VARCHAR(255) NOT NULL
6. **Surgery**
   - SurgeryID（手术ID）：INT AUTO_INCREMENT, 主键
   - MedicalRecordID（病历记录ID）：INT, 外键
   - SurgeryDate（手术日期）：DATE NOT NULL
   - SurgeryName（手术名称）：VARCHAR(255)
   - SurgeonID（主刀医生ID）：INT, 外键
   - AssistantSurgeonID（助手医生ID）：INT, 外键
7. **Unit**
   - UnitID（科室ID）：INT AUTO_INCREMENT, 主键
   - Name（名称）：VARCHAR(255) NOT NULL
8. **Ward**
   - WardID（病房ID）：INT AUTO_INCREMENT, 主键
   - UnitID（科室ID）：INT, 外键
   - Description（描述）：VARCHAR(255)
9. **MedicalRecordWards**
   - MedicalRecordID（病历记录ID）：INT, 外键
   - WardID（病房ID）：INT, 外键
   - StartTime（开始时间）：DATETIME
   - EndTime（结束时间）：DATETIME
10. **Cost**
    - CostID（费用ID）：INT AUTO_INCREMENT, 主键
    - MedicalRecordID（病历记录ID）：INT, 外键
    - Amount（金额）：DECIMAL(10, 2) NOT NULL
    - Kind（种类）：VARCHAR(50)
11. **Staff**
    - StaffID（员工ID）：INT AUTO_INCREMENT, 主键
    - Name（姓名）：VARCHAR(255) NOT NULL
    - Position（职位）：VARCHAR(255）
    - UnitID（科室ID）：INT, 外键
12. **BloodType**
    - BloodTypeID（血型ID）：INT AUTO_INCREMENT, 主键
    - Type（血型类型）：VARCHAR(50) NOT NULL
    - RhType（Rh因子）：VARCHAR(50) NOT NULL
13. **MedicalRecordBorrow**
    - BorrowID（借阅ID）：INT AUTO_INCREMENT, 主键
    - MedicalRecordNumber（病历编号）：INT NOT NULL, 外键
    - BorrowDate（借阅日期）：DATETIME NOT NULL
    - BorrowedBy（借阅人）：VARCHAR(255) NOT NULL
    - UnitID（科室ID）：INT, 外键
    - IDCardNumber（身份证号码）：INT, 外键
    - BorrowReason（借阅原因）：TEXT
    - ContactPhone（联系电话）：VARCHAR(18)
    - Approver（审批人）：VARCHAR(255)
    - Status（状态）：ENUM('Pending', 'Approved', 'Rejected') NOT NULL DEFAULT 'Pending'
14. **MedicalRecordReturn**
    - ReturnID（归还ID）：INT AUTO_INCREMENT, 主键
    - MedicalRecordNumber（病历编号）：INT NOT NULL, 外键
    - ReturnDate（归还日期）：DATETIME NOT NULL
    - ReturnedBy（归还人）：VARCHAR(255) NOT NULL
    - UnitID（科室ID）：INT, 外键
    - IDCardNumber（身份证号码）：INT, 外键
    - ContactPhone（联系电话）：VARCHAR(18）

#### 2.4 系统的安全性设计
- 对于不同用户角色，我们应当为其分配不同的访问权限，在执行病案管理相关功能前进行检查并执行安全措施。

- 根据实际需求，我们在设计报告中就已经确认了各用户应具有的权限：

  对于病人，其无法对病案进行CUD操作，只能对病案进行查询，获得自己有关的病案信息。

  对于医生，其无法进行病案借阅的审批，以及医生不需要了解整体的统计数据，即无法使用数据统计功能。综上所述，医生可以进行全部CRUD操作，也可以提交病案借阅与归还申请，但其无法审批这些申请且不能查看病案统计数据。

  对于病案管理人员，我们应该赋予其最大最多的权限，所以我们允许他使用病案管理系统的全部功能。

- 安全防护的主要函数如下，当返回值为false时，我们应拒绝当前功能的执行。

  ```python
  def check_permission(username, function):
      identity = get_user_identity(username)
      user_entities = {
          'Patient': {'permissions': [
                          'medical_record_search',
                          'disease_info_search',
                          'surgery_info_search',
                          'patient_info_search',
                          '病案检索',
                          '疾病信息查询',
                          '手术信息查询',
                          '患者信息查询']},
          'Doctor': {'permissions': [
                          'medical_record_create', '新建病案',
                          'medical_record_update', '修改病案',
                          'medical_record_delete', '删除病案',
                          'medical_record_borrow', '病案借阅',
                          'medical_record_return', '病案归还',
                          'medical_record_search', '病案检索',
                          'disease_info_search',   '疾病信息查询',
                          'surgery_info_search',   '手术信息查询',
                          'patient_info_search',   '患者信息查询',
                          'medical_record_borrow', '借阅信息查询',
                          'admission_info_search', '入院信息查询',
                          'discharge_info_search', '出院信息查询']},
          'Manager': {'permissions': [
                          'medical_record_create', '新建病案',
                          'medical_record_update', '修改病案',
                          'medical_record_delete', '删除病案',
                          'medical_record_borrow', '病案借阅',
                          'medical_record_return', '病案归还',
                          'borrow_approval',       '借阅审批',
                          'medical_record_search', '病案检索',
                          'disease_info_search',   '疾病信息查询',
                          'surgery_info_search',   '手术信息查询',
                          'patient_info_search',   '患者信息查询',
                          'medical_record_borrow', '借阅信息查询',
                          'admission_info_search', '入院信息查询',
                          'discharge_info_search', '出院信息查询',
                          'discharge_info_search', '医疗费用报表',
                          'unit_visit_report',     '科室就诊情况报表',
                          'disease_classification_report', '疾病分类报表',
                          'discharge_info_report', '出院病人信息报表']}
      }
      # 根据身份获取权限列表
      user_permissions = user_entities[identity]['permissions']
      # 检查用户是否有执行该功能的权限
      return function in user_permissions
  ```

  

#### 2.5 存储过程、触发器和函数的代码说明
- 提供数据库中存储过程、触发器和函数的实现代码。

  触发器和函数没有使用，对于存储过程，有如下代码：

  对于用户登录与注册，我们有如下数据库代码：

  ```mysql
  
  ```

  对于新建病案，我们有如下数据库代码：

  ```mysql
  
  ```

  对于查询病案，我们有如下数据库代码：

  ```mysql
  
  ```

  对于删除病案，我们有如下数据库代码：

  ```mysql
  
  ```

  对于病案借阅与归还，我们有如下数据库代码：

  ```mysql
  
  ```

  对于相关信息的查询，我们有如下数据库代码：

  ```mysql
  
  ```

  对于数据统计，我们有如下数据库代码：

  ```mysql
  
  ```

  

​	

#### 2.6 实现过程中主要技术和主要模块的论述
- 讨论在实现过程中使用的关键技术和遇到的主要模块。

#### 2.7 若干展示系统功能的运行实例
- 提供系统功能的实际操作示例，包括界面截图和操作步骤。

#### 2.8 源程序简要说明
- 提供关键源代码的简要说明，包括主要函数和类。

#### 2.9 收获和体会
- 总结在系统开发过程中的学习和经验。

